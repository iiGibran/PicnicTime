<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="theme-color" content="#0a84ff"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="apple-mobile-web-app-title" content="PicnicRIT"><title>PicnicRIT</title><style>
:root{--bg:#0b0b0f;--card:#14141a;--muted:#9aa0a6;--text:#f2f3f5;--accent:#0a84ff;--danger:#ff453a;--ok:#30d158;--warn:#ffcc00;--line:rgba(255,255,255,.08)}
@media (prefers-color-scheme: light){:root{--bg:#f5f5f7;--card:#ffffff;--muted:#6b7280;--text:#111827;--accent:#0a84ff;--danger:#dc2626;--ok:#16a34a;--warn:#b45309;--line:rgba(17,24,39,.08)}}
*{box-sizing:border-box}html,body{height:100%;width:100%;max-width:100%;overflow-x:hidden}body{margin:0;width:100vw;overflow-x:hidden;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-text-size-adjust:100%}
.wrap{max-width:740px;margin:0 auto;padding:18px 14px calc(40px + env(safe-area-inset-bottom))}
@media(max-width:430px){.wrap{padding:14px 12px calc(34px + env(safe-area-inset-bottom));max-width:100%;width:100%}}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 2px 14px;position:sticky;top:0;background:linear-gradient(to bottom,var(--bg) 70%,transparent);padding-top:env(safe-area-inset-top);padding-bottom:10px;z-index:10}
.brand{display:flex;align-items:center;gap:10px;min-width:0}
.logo{width:38px;height:38px;border-radius:12px;background:var(--accent);display:grid;place-items:center;color:#fff;font-weight:900;flex:0 0 auto}
h1{font-size:18px;margin:0;line-height:1.1}
.sub{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:44vw}
.tabs{display:flex;gap:8px;flex:0 0 auto}
.tab{border:1px solid var(--line);background:transparent;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:800;font-size:13px;min-height:44px}
.tab.active{background:var(--card);border-color:transparent;box-shadow:0 1px 0 rgba(0,0,0,.08)}
.card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px}
@media(max-width:430px){.card{padding:12px;border-radius:16px}}
.grid{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:520px){.grid{grid-template-columns:1fr 1fr}}
.field{display:flex;flex-direction:column;gap:6px;min-width:0}
label{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.2px}
input[type="time"],input[type="date"],select{width:100%;max-width:100%;min-width:0;padding:12px 12px;border-radius:14px;border:1px solid var(--line);background:transparent;color:var(--text);font-size:17px;outline:none;min-height:48px}
select{appearance:none}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{border:0;border-radius:14px;padding:12px 14px;font-weight:900;font-size:14px;min-height:48px;transition:transform .08s ease,filter .08s ease,background-color .12s ease}
.btn:active{transform:scale(.97);filter:brightness(.9)}
.btn.primary{background:var(--accent);color:#fff;flex:1;min-width:170px}
.btn.ok{background:var(--ok);color:#fff;flex:1;min-width:170px}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--line);min-width:120px}
.btn.danger{background:var(--danger);color:#fff;min-width:120px}
.btn:disabled{opacity:.5;transform:none;filter:none}
.kpis{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
@media(min-width:520px){.kpis{grid-template-columns:1fr 1fr}}
.kpi{border:1px solid var(--line);border-radius:16px;padding:12px}
.kpi .t{font-size:12px;color:var(--muted);font-weight:800}
.kpi .v{font-size:20px;font-weight:950;margin-top:6px}
.kpi .h{font-size:12px;color:var(--muted);margin-top:6px}
.sep{height:1px;background:var(--line);margin:14px 0}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.toolbar .btn{min-width:auto;flex:0 0 auto}
.badge{font-size:12px;color:var(--muted);font-weight:800}
.list{display:flex;flex-direction:column;gap:8px}
.item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border:1px solid var(--line);border-radius:16px;min-height:56px}
.item.active{border-color:rgba(10,132,255,.45);box-shadow:0 0 0 3px rgba(10,132,255,.12)}
.item .left{display:flex;flex-direction:column;gap:4px;min-width:0}
.item .d{font-weight:950}
.item .m{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--line);font-weight:950;white-space:nowrap}
.pill.ok{border-color:rgba(48,209,88,.35);color:var(--ok)}
.pill.warn{border-color:rgba(255,204,0,.6);color:var(--warn)}
.pill.muted{color:var(--muted)}
.detail{margin-top:12px;border:1px solid var(--line);border-radius:16px;padding:12px}
.detailgrid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
@media(min-width:520px){.detailgrid{grid-template-columns:1fr 1fr}}
.kv{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--line);border-radius:14px}
.kv .k{font-size:12px;color:var(--muted);font-weight:800}
.kv .v{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60%}
.notice{padding:12px;border-radius:16px;border:1px dashed var(--line);color:var(--muted);font-size:12px;margin-top:14px}
.hidden{display:none}
a{color:var(--accent);text-decoration:none}
@media(max-width:430px){
.top{gap:10px}
.sub{max-width:38vw}
.tabs{gap:6px}
.tab{padding:10px 10px;min-width:0}
.row{flex-direction:column}
.btn{width:100%;min-width:0;flex:0 0 auto}
.toolbar{justify-content:space-between}
}
</style></head><body><div class="wrap"><div class="top"><div class="brand"><div class="logo">P</div><div style="min-width:0"><h1>PicnicRIT</h1><div class="sub" id="subtitle"></div></div></div><div class="tabs"><button class="tab active" id="tabToday">Today</button><button class="tab" id="tabWeek">Week</button></div></div>

<div id="viewToday" class="card">
<div class="grid">
<div class="field"><label>Date</label><input id="date" type="date"></div>
<div class="field"><label>Check In</label><input id="checkIn" type="time" step="60"></div>
<div class="field"><label>RIT count</label><select id="ritCount"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select></div>
<div class="field"><label>Check Out</label><input id="checkOut" type="time" step="60"></div>
</div>
<div id="ritContainer" class="grid" style="margin-top:10px"></div>

<div class="row">
<button class="btn primary" id="saveBtn">Save progress</button>
<button class="btn ok" id="finishBtn">Shift finished</button>
<button class="btn ghost" id="fillNowBtn">Fill now</button>
<button class="btn danger" id="deleteBtn">Delete day</button>
</div>

<div class="kpis">
<div class="kpi"><div class="t">Status</div><div class="v" id="kStatus">--</div><div class="h" id="hStatus"></div></div>
<div class="kpi"><div class="t">Total Worked Today</div><div class="v" id="kTotal">--</div><div class="h">Check Out − Check In</div></div>
</div>

<div class="kpis">
<div class="kpi"><div class="t">Total RIT Time</div><div class="v" id="kRit">--</div><div class="h">Sum of all RITs</div></div>
<div class="kpi"><div class="t">This Week Total (RIT)</div><div class="v" id="kWeek">--</div><div class="h" id="hWeek"></div></div>
</div>

<div class="notice">Saved on this device. Week → Download backup sometimes.</div>
</div>

<div id="viewWeek" class="card hidden">
<div class="toolbar">
<button class="btn ghost" id="prevWeekBtn">◀︎ Prev</button>
<button class="btn ghost" id="thisWeekBtn">This week</button>
<button class="btn ghost" id="nextWeekBtn">Next ▶︎</button>
<span class="badge" id="weekRange"></span>
</div>
<div class="sep"></div>
<div class="list" id="weekList"></div>

<div id="dayDetail" class="detail hidden">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
<div>
<div style="font-weight:950" id="detailTitle">Day</div>
<div class="badge" id="detailSub"></div>
</div>
<button class="btn ghost" id="editDayBtn">Edit</button>
</div>
<div class="detailgrid">
<div class="kv"><div class="k">Status</div><div class="v" id="dStatus">--</div></div>
<div class="kv"><div class="k">Check In</div><div class="v" id="dCheckIn">--</div></div>
<div class="kv"><div class="k">Check Out</div><div class="v" id="dCheckOut">--</div></div>
<div class="kv"><div class="k">Total Worked</div><div class="v" id="dTotal">--</div></div>
<div class="kv"><div class="k">Total RIT</div><div class="v" id="dRitTotal">--</div></div>
</div>
<div id="detailRits" class="detailgrid"></div>
</div>

<div class="sep"></div>
<div class="kpis">
<div class="kpi"><div class="t">Weekly Total (RIT)</div><div class="v" id="wkTotal">--</div><div class="h">Sum of finished days in this week</div></div>
<div class="kpi"><div class="t">Backup</div><div class="v" style="font-size:14px;font-weight:950">JSON</div><div class="h"><a href="#" id="exportBtn">Download</a> · <a href="#" id="importBtn">Import</a></div></div>
</div>
<input id="importFile" type="file" accept="application/json" class="hidden">
</div>

</div>

<script>
const NEWKEY="picnicrit_entries_v1"
const OLDKEYS=["workrit_entries_v4","workrit_entries_v3","workrit_entries_v2","workrit_entries_v1"]
const $=id=>document.getElementById(id)
const tabToday=$("tabToday"),tabWeek=$("tabWeek"),viewToday=$("viewToday"),viewWeek=$("viewWeek")
const dateEl=$("date"),checkInEl=$("checkIn"),checkOutEl=$("checkOut"),ritCountEl=$("ritCount"),ritContainer=$("ritContainer")
const saveBtn=$("saveBtn"),finishBtn=$("finishBtn"),deleteBtn=$("deleteBtn"),fillNowBtn=$("fillNowBtn")
const kStatus=$("kStatus"),hStatus=$("hStatus"),kRit=$("kRit"),kTotal=$("kTotal"),kWeek=$("kWeek"),hWeek=$("hWeek"),subtitle=$("subtitle")
const prevWeekBtn=$("prevWeekBtn"),nextWeekBtn=$("nextWeekBtn"),thisWeekBtn=$("thisWeekBtn"),weekRangeEl=$("weekRange"),weekList=$("weekList"),wkTotal=$("wkTotal"),exportBtn=$("exportBtn"),importBtn=$("importBtn"),importFile=$("importFile")
const dayDetail=$("dayDetail"),detailTitle=$("detailTitle"),detailSub=$("detailSub"),editDayBtn=$("editDayBtn"),detailRits=$("detailRits")
const dStatus=$("dStatus"),dCheckIn=$("dCheckIn"),dCheckOut=$("dCheckOut"),dTotal=$("dTotal"),dRitTotal=$("dRitTotal")
const pad=n=>String(n).padStart(2,"0")
const toYMD=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`
const parseTime=(ymd,hm)=>{if(!hm||!ymd)return null;const [H,M]=hm.split(":").map(Number);const [y,m,da]=ymd.split("-").map(Number);return new Date(y,m-1,da,H,M,0,0)}
const msBetween=(a,b)=>a&&b?b.getTime()-a.getTime():null
const clampNonNeg=ms=>ms==null?null:Math.max(0,ms)
const fmtDur=ms=>{if(ms==null)return"--";ms=Math.round(ms/60000)*60000;const totalMin=Math.max(0,Math.floor(ms/60000));const h=Math.floor(totalMin/60),m=totalMin%60;return `${h}h ${pad(m)}m`}
const weekStart=d=>{const c=new Date(d.getFullYear(),d.getMonth(),d.getDate(),12,0,0,0);const day=(c.getDay()+6)%7;c.setDate(c.getDate()-day);c.setHours(0,0,0,0);return c}
const weekEndExclusive=d=>{const s=weekStart(d);const e=new Date(s);e.setDate(e.getDate()+7);return e}
const inRange=(d,start,endEx)=>d>=start&&d<endEx
const clean=v=>v&&v.trim()?v.trim():""
const safeParse=(raw)=>{try{const o=JSON.parse(raw);return o&&typeof o==="object"?o:{} }catch{return{}}}
const loadKey=k=>safeParse(localStorage.getItem(k)||"{}")
const saveKey=(k,obj)=>localStorage.setItem(k,JSON.stringify(obj))
const ensureMigration=()=>{
let cur=loadKey(NEWKEY)
if(Object.keys(cur).length>0)return cur
for(const k of OLDKEYS){
const old=loadKey(k)
if(Object.keys(old).length===0)continue
const migrated={}
for(const [ymd,e0] of Object.entries(old)){
const e=(e0&&typeof e0==="object")?e0:{}
let rits=[]
let count=1
if(Array.isArray(e.rits)){
rits=e.rits.map(x=>({start:clean(x.start||x.ritStart||""),end:clean(x.end||x.ritEnd||"")})).slice(0,4)
count=parseInt(e.ritCount||rits.length||1,10)||1
}else{
const s=clean(e.ritStart||"")
const en=clean(e.ritEnd||"")
rits=[{start:s,end:en}]
count=parseInt(e.ritCount||1,10)||1
}
if(count<1)count=1
if(count>4)count=4
while(rits.length<count)rits.push({start:"",end:""})
rits=rits.slice(0,count)
const finished=typeof e.finished==="boolean"?e.finished:(clean(e.checkIn)&&clean(e.checkOut)&&rits.every(r=>clean(r.start)&&clean(r.end))?true:false)
migrated[ymd]={checkIn:clean(e.checkIn||""),checkOut:clean(e.checkOut||""),ritCount:count,rits,finished}
}
saveKey(NEWKEY,migrated)
return migrated
}
return cur
}
let store=ensureMigration()
const reload=()=>{store=loadKey(NEWKEY);return store}
const getEntry=ymd=>reload()[ymd]||null
const setEntry=(ymd,entry)=>{const all=reload();all[ymd]=entry;saveKey(NEWKEY,all)}
const delEntry=ymd=>{const all=reload();delete all[ymd];saveKey(NEWKEY,all)}

const buildRitInputs=count=>{
ritContainer.innerHTML=""
for(let i=1;i<=count;i++){
const a=document.createElement("div");a.className="field";a.innerHTML=`<label>RIT ${i} Start</label><input id="rit${i}Start" type="time" step="60">`
const b=document.createElement("div");b.className="field";b.innerHTML=`<label>RIT ${i} End</label><input id="rit${i}End" type="time" step="60">`
ritContainer.appendChild(a);ritContainer.appendChild(b)
}
for(const el of ritContainer.querySelectorAll("input[type=time]"))el.addEventListener("input",renderToday)
}

const getRitsFromInputs=()=>{
const count=parseInt(ritCountEl.value,10)||1
const rits=[]
for(let i=1;i<=count;i++){
const s=document.getElementById(`rit${i}Start`)
const e=document.getElementById(`rit${i}End`)
rits.push({start:clean(s&&s.value||""),end:clean(e&&e.value||"")})
}
return{count,rits}
}

const setRitsToInputs=(count,rits)=>{
ritCountEl.value=String(count)
buildRitInputs(count)
for(let i=1;i<=count;i++){
const s=document.getElementById(`rit${i}Start`)
const e=document.getElementById(`rit${i}End`)
const r=rits[i-1]||{start:"",end:""}
if(s)s.value=r.start||""
if(e)e.value=r.end||""
}
}

const computeFrom=(ymd,entry)=>{
const ci=parseTime(ymd,clean(entry.checkIn||""))
const co=parseTime(ymd,clean(entry.checkOut||""))
const span=clampNonNeg(msBetween(ci,co))
let ritSum=0
let anyComplete=false
let anyPartial=false
for(const r of (entry.rits||[])){
const rs=parseTime(ymd,clean(r.start||""))
const re=parseTime(ymd,clean(r.end||""))
if(rs&&re){anyComplete=true;ritSum+=clampNonNeg(msBetween(rs,re))||0}
else if(rs||re){anyPartial=true}
}
const rit=anyComplete?ritSum:null
return{span,rit,anyPartial}
}

const hasAnyData=e=>!!(e&&(clean(e.checkIn||"")||clean(e.checkOut||"")||(e.rits||[]).some(r=>clean(r.start)||clean(r.end))||e.ritCount))
const statusFor=e=>{
if(!hasAnyData(e))return{t:"Empty",h:"Fill times then Save progress"}
if(e.finished===true)return{t:"Finished",h:"Done"}
return{t:"In progress",h:"Saved but not finished"}
}

let weekOffset=0
let selectedYmd=null
const weekAnchor=()=>{const d=new Date();d.setHours(12,0,0,0);d.setDate(d.getDate()+weekOffset*7);return d}
const currentWeekRange=()=>{const a=weekAnchor();const ws=weekStart(a),we=weekEndExclusive(a);return{ws,we}}
const labelWeekRange=(ws,we)=>`${toYMD(ws)} → ${toYMD(new Date(we.getTime()-86400000))}`

const renderThisWeekSummary=()=>{
const now=new Date()
const ws=weekStart(now),we=weekEndExclusive(now)
let sum=0
for(const [ymd,e] of Object.entries(reload())){
const d=new Date(ymd+"T00:00:00")
if(inRange(d,ws,we)&&e&&e.finished===true){
const r=computeFrom(ymd,e)
if(r.rit!=null)sum+=r.rit
}}
kWeek.textContent=fmtDur(sum)
hWeek.textContent=labelWeekRange(ws,we)
subtitle.textContent=`Week: ${labelWeekRange(ws,we)}`
}

const renderToday=()=>{
const ymd=dateEl.value
const saved=getEntry(ymd)||{}
const st=statusFor(saved)
kStatus.textContent=st.t
hStatus.textContent=st.h
const {count,rits}=getRitsFromInputs()
const r=computeFrom(ymd,{checkIn:checkInEl.value,checkOut:checkOutEl.value,ritCount:count,rits})
kTotal.textContent=fmtDur(r.span)
kRit.textContent=fmtDur(r.rit)
finishBtn.disabled=!(clean(checkInEl.value)&&clean(checkOutEl.value)&&rits.every(x=>clean(x.start)&&clean(x.end)))
renderThisWeekSummary()
}

const renderWeekView=()=>{
const {ws,we}=currentWeekRange()
weekRangeEl.textContent=labelWeekRange(ws,we)
const all=reload()
const days=[]
for(let i=0;i<7;i++){const d=new Date(ws);d.setDate(d.getDate()+i);const ymd=toYMD(d);days.push({d,ymd,e:all[ymd]||null})}
weekList.innerHTML=""
let sum=0
for(const day of days){
let pillClass="muted",pillText="No entry"
if(day.e&&hasAnyData(day.e)){
const r=computeFrom(day.ymd,day.e)
if(day.e.finished===true&&r.rit!=null){pillClass="ok";pillText=fmtDur(r.rit);sum+=r.rit}
else{pillClass="warn";pillText="In progress"}
}
const name=day.d.toLocaleDateString(undefined,{weekday:"long"})
const dstr=day.d.toLocaleDateString(undefined,{month:"short",day:"numeric"})
const item=document.createElement("div")
item.className="item"+(selectedYmd===day.ymd?" active":"")
item.innerHTML=`<div class="left"><div class="d">${name}</div><div class="m">${dstr} · ${day.ymd}</div></div><div class="pill ${pillClass}">${pillText}</div>`
item.addEventListener("click",()=>{selectedYmd=day.ymd;renderWeekView();renderDayDetail(day.ymd,day.d,day.e)})
weekList.appendChild(item)
}
wkTotal.textContent=fmtDur(sum)
if(!selectedYmd){dayDetail.classList.add("hidden")}else{
const sd=new Date(selectedYmd+"T00:00:00")
if(!inRange(sd,ws,we)){selectedYmd=null;dayDetail.classList.add("hidden")}}
}

const renderDayDetail=(ymd,dayDate,entry)=>{
dayDetail.classList.remove("hidden")
const name=dayDate.toLocaleDateString(undefined,{weekday:"long"})
const dstr=dayDate.toLocaleDateString(undefined,{month:"long",day:"numeric",year:"numeric"})
detailTitle.textContent=name
detailSub.textContent=`${dstr} · ${ymd}`
const e=entry||getEntry(ymd)||{}
const st=statusFor(e)
dStatus.textContent=st.t
dCheckIn.textContent=clean(e.checkIn)||"--"
dCheckOut.textContent=clean(e.checkOut)||"--"
const r=computeFrom(ymd,e)
dTotal.textContent=fmtDur(r.span)
dRitTotal.textContent=fmtDur(r.rit)
detailRits.innerHTML=""
const count=parseInt(e.ritCount||1,10)||1
const rits=Array.isArray(e.rits)?e.rits:[]
for(let i=1;i<=count;i++){
const rr=rits[i-1]||{start:"",end:""}
const wrap=document.createElement("div")
wrap.className="kv"
wrap.innerHTML=`<div class="k">RIT ${i}</div><div class="v">${clean(rr.start)||"--"} → ${clean(rr.end)||"--"}</div>`
detailRits.appendChild(wrap)
}
editDayBtn.onclick=()=>{switchToToday();dateEl.value=ymd;loadIntoForm(ymd)}
}

const loadIntoForm=ymd=>{
const e=getEntry(ymd)
if(e){
checkInEl.value=e.checkIn||""
checkOutEl.value=e.checkOut||""
const c=parseInt(e.ritCount||1,10)||1
setRitsToInputs(c,(e.rits||[]).slice(0,c))
}else{
checkInEl.value=""
checkOutEl.value=""
setRitsToInputs(1,[{start:"",end:""}])
}
renderToday()
}

const switchToToday=()=>{tabToday.classList.add("active");tabWeek.classList.remove("active");viewToday.classList.remove("hidden");viewWeek.classList.add("hidden");renderToday()}
const switchToWeek=()=>{tabWeek.classList.add("active");tabToday.classList.remove("active");viewWeek.classList.remove("hidden");viewToday.classList.add("hidden");renderWeekView()}
tabToday.addEventListener("click",switchToToday)
tabWeek.addEventListener("click",switchToWeek)
prevWeekBtn.addEventListener("click",()=>{weekOffset-=1;selectedYmd=null;renderWeekView()})
nextWeekBtn.addEventListener("click",()=>{weekOffset+=1;selectedYmd=null;renderWeekView()})
thisWeekBtn.addEventListener("click",()=>{weekOffset=0;selectedYmd=null;renderWeekView()})

const validateFinish=()=>{
const ymd=dateEl.value
if(!ymd)return{ok:false,msg:"Pick a date"}
if(!clean(checkInEl.value)||!clean(checkOutEl.value))return{ok:false,msg:"Fill check-in and check-out"}
const {count,rits}=getRitsFromInputs()
for(let i=0;i<count;i++){if(!clean(rits[i].start)||!clean(rits[i].end))return{ok:false,msg:"Fill all RIT start/end"}}
const ci=parseTime(ymd,checkInEl.value)
const co=parseTime(ymd,checkOutEl.value)
if(!(ci&&co)&&ci>co)return{ok:false,msg:"Times must be in order"}
for(let i=0;i<count;i++){
const rs=parseTime(ymd,rits[i].start)
const re=parseTime(ymd,rits[i].end)
if(!(rs&&re))return{ok:false,msg:"Fill all times"}
if(!(ci<=rs&&rs<=re&&re<=co))return{ok:false,msg:"Times must be in order"}
}
return{ok:true,msg:""}
}

saveBtn.addEventListener("click",()=>{
const ymd=dateEl.value
if(!ymd){alert("Pick a date");return}
const existing=getEntry(ymd)||{}
const {count,rits}=getRitsFromInputs()
const old=Array.isArray(existing.rits)?existing.rits:[]
const mergedRits=[]
for(let i=0;i<count;i++){
const cur=rits[i]||{start:"",end:""}
const prev=old[i]||{start:"",end:""}
mergedRits.push({start:clean(cur.start)||clean(prev.start)||"",end:clean(cur.end)||clean(prev.end)||""})
}
setEntry(ymd,{checkIn:clean(checkInEl.value)||clean(existing.checkIn)||"",checkOut:clean(checkOutEl.value)||clean(existing.checkOut)||"",ritCount:count,rits:mergedRits,finished:false})
renderToday()
alert("Saved")
})

finishBtn.addEventListener("click",()=>{
const v=validateFinish()
if(!v.ok){alert(v.msg);return}
const ymd=dateEl.value
const {count,rits}=getRitsFromInputs()
setEntry(ymd,{checkIn:clean(checkInEl.value),checkOut:clean(checkOutEl.value),ritCount:count,rits:rits.map(x=>({start:clean(x.start),end:clean(x.end)})),finished:true})
renderToday()
alert("Shift saved")
})

deleteBtn.addEventListener("click",()=>{
const ymd=dateEl.value
if(!ymd){alert("Pick a date");return}
if(confirm("Delete this day?")){delEntry(ymd);loadIntoForm(ymd);alert("Deleted")}}
)

fillNowBtn.addEventListener("click",()=>{
const now=new Date()
const t=`${pad(now.getHours())}:${pad(now.getMinutes())}`
if(!checkInEl.value)checkInEl.value=t
else{
const {count}=getRitsFromInputs()
let placed=false
for(let i=1;i<=count;i++){
const s=document.getElementById(`rit${i}Start`)
const e=document.getElementById(`rit${i}End`)
if(s&&!s.value){s.value=t;placed=true;break}
if(e&&!e.value){e.value=t;placed=true;break}
}
if(!placed&&!checkOutEl.value)checkOutEl.value=t
}
renderToday()
})

ritCountEl.addEventListener("change",()=>{
const count=parseInt(ritCountEl.value,10)||1
const cur=getRitsFromInputs().rits
const padded=[]
for(let i=0;i<count;i++)padded.push(cur[i]||{start:"",end:""})
setRitsToInputs(count,padded)
renderToday()
})

for(const el of [dateEl,checkInEl,checkOutEl])el.addEventListener("input",renderToday)

exportBtn.addEventListener("click",(e)=>{
e.preventDefault()
const data=localStorage.getItem(NEWKEY)||"{}"
const blob=new Blob([data],{type:"application/json"})
const url=URL.createObjectURL(blob)
const a=document.createElement("a")
a.href=url
a.download="picnicrit-backup.json"
document.body.appendChild(a)
a.click()
a.remove()
setTimeout(()=>URL.revokeObjectURL(url),500)
})

importBtn.addEventListener("click",(e)=>{e.preventDefault();importFile.click()})
importFile.addEventListener("change",async()=>{
const f=importFile.files&&importFile.files[0]
if(!f)return
try{const t=await f.text();const obj=JSON.parse(t);if(!obj||typeof obj!=="object")throw new Error("bad");saveKey(NEWKEY,obj);alert("Imported");renderToday();renderWeekView()}catch{alert("Import failed")}
importFile.value=""
})

const init=()=>{
buildRitInputs(1)
const today=toYMD(new Date())
dateEl.value=today
loadIntoForm(today)
}
init()
</script></body></html>
